'use strict';var HelloZeronet='http://127.0.0.1:43110/1HeLLo4uzjaLetFx6NH3PMwFP3qbRbTf3D';const{electron,app,crashReporter,globalShortcut,ipcMain,protocol,remote,BrowserWindow,Menu,MenuItem,Tray}=require('electron'),electronLocalshortcut=require('electron-localshortcut');global.sharedObject={prop1:process.argv};const fs=require('fs'),os=require('os'),url=require('url'),path=require('path'),dir=require('node-dir');var _=require('underscore'),_exist=require('is-there'),program=require('commander'),monogamous=require('monogamous'),Configstore=require('configstore'),spawn=require('electron-spawn');const spawnChild=require('child_process').spawn,ChildProcess=require('child_process');var appLogger=require('./js/logger'),appMenu=require('./js/menu'),appTray=require('./js/tray'),appIcons=require('./gfx/icons'),historyPath=app.getPath('userData')+'/userdata/history.json',extensionsPath=app.getPath('userData').replace(/\\/g,'/')+'/userdata/extensions',userdataPath=app.getPath('userData')+'/userdata',configPath=app.getPath('userData')+'/personal.config',pkg=require('./package.json');function Config(a,b){this.config=new Configstore(pkg.name,{}),this.cliOverrides=a;var c=this;ipcMain.on('get-config-sync',function(e){e.returnValue=JSON.stringify(c.getAll())}),ipcMain.on('get-config-info-sync',function(e){e.returnValue=JSON.stringify(b)}),ipcMain.on('get-config-overrides-sync',function(e){e.returnValue=JSON.stringify(a)}),ipcMain.on('set-config-item-sync',function(e,f,g){c.set(f,g),e.returnValue=JSON.stringify({success:!0})})}if(Config.prototype={getAll:function(){return _.defaults({},this.cliOverrides,this.config.all)},get:function(a){var b=this.getAll();return b[a]},set:function(a,b){return this.config.set(a,b)},del:function(a){return this.config.del(a)},clear:function(){return this.config.clear()}},fs.existsSync(configPath)){var configs=require(configPath);if('object'==typeof configs&&(configs=JSON.stringify(configs),configs=JSON.parse(configs),configs.enable_proxy))for(var key in configs.proxy)configs.proxy.hasOwnProperty(key)&&configs.proxy[key]&&app.commandLine.appendSwitch('proxy-'+key,configs.proxy[key])}program.version(pkg.version).option('-S, --skip-taskbar','Skip showing the application in the taskbar').option('--minimize-to-tray','Hide window to tray instead of minimizing').option('--hide-via-tray','Hide window to tray instead of minimizing (only for tray icon)').option('--allow-multiple-instances','Allow multiple instances of `Fuzium` to run').option('--verbose','Display verbose log output in stdout').allowUnknownOption();var cliConfigKeys=['skip-taskbar','minimize-to-tray','hide-via-tray','allow-multiple-instances'],cliInfo=_.object(cliConfigKeys.map(function(b){return[b,_.findWhere(program.options,{long:'--'+b})]})),logger=appLogger({verbose:program.verbose+''});console.log(''),program._cliConfigKeys=cliConfigKeys,program._cliInfo=cliInfo;function camelcase(a){return a.split('-').reduce(function(b,c){return b+c[0].toUpperCase()+c.slice(1)})}var cliConfig=_.object(program._cliConfigKeys.map(function(b){var c=camelcase(b);return[b,program[c]]})),config=new Config(cliConfig,program._cliInfo,'\n');logger.debug('Config options \n',config.getAll(),'\n'),app.on('ready',function(){booter?booter.boot():startApp()}),app.on('window-all-closed',function(){'darwin'!=process.platform&&app.quit()});var windows_built=!1,open_url;app.on('open-url',function(a,b){a.preventDefault(),open_url=b,console.log(open_url),windows_built});var logo=appIcons.logo;let func={browserWindow:null,config:config,logger:logger,openAboutWindow:function(){var a=['<style type="text/css">','body { background: #252020; color: #E0C0C0; font-family: "Arial", "sans-serif"; }','p { color: orange; }','</style>','<div style="text-align: center; font-family: \'Helvetica Neue\', \'Arial\', \'sans-serif\'">','<h3>About</h3>','<p>','Version: '+pkg.version,'<br/>','Electron version: '+process.versions.electron,'<br/>','Node.js version: '+process.versions.node,'<br/>','Chromium version: '+process.versions.chrome,'</p>','<p>Arguments: <script>document.write(require(\'electron\').remote.process.argv)</script></p>','<br>','<img src="'+logo+'">','</div>'].join(''),b=new BrowserWindow({title:'About',width:420,height:240,autoHideMenuBar:!0,titleBarStyle:'hidden-inset',icon:appIcons['info-32']});b.loadURL('data:text/html,'+a),logger.debug('Show app info')},openConfigWindow:function(){var a=new BrowserWindow({title:'Prefs',width:620,height:330,autoHideMenuBar:!0,titleBarStyle:'hidden-inset',icon:appIcons['info-32']}),b=__dirname+'/js/config.htm';a.loadURL(b),logger.debug('Show config; '+b)},quitApplication:function(){logger.debug('Exiting'),app.quit()},reloadWindow:function(){logger.debug('Reloading'),BrowserWindow.getFocusedWindow().reload()},showMinimizedWindow:function(){func.browserWindow.restore(),func.browserWindow.focus(),logger.debug('Browser focus')},showInvisibleWindow:function(){func.browserWindow.show()},toggleDevTools:function(){logger.debug('Toggle developer tools'),BrowserWindow.getFocusedWindow().toggleDevTools()},toggleFullScreen:function(){var a=BrowserWindow.getFocusedWindow(),b=a.isFullScreen(),c=!b;logger.debug('Toggle focused window size; \n',{wasFullScreen:b,toggledFullScreen:c}),a.setFullScreen(c)},toggleMinimize:function(){if(func.browserWindow){var a=func.browserWindow.isMinimized();logger.debug('Toggle browser window minimization',{isMinimized:a}),a?func.showMinimizedWindow():func.browserWindow.minimize()}else logger.debug('Window minimization toggle requested but browser window not found')},toggleVisibility:function(){if(func.browserWindow){var a=func.browserWindow.isVisible();logger.debug('Toggling browser window visibility',{isVisible:a}),a?func.browserWindow.hide():func.showInvisibleWindow()}else logger.debug('Window visibility toggle requested but browser window not found')}};function checkPaths(){_exist(userdataPath)||fs.mkdir(userdataPath),_exist(extensionsPath)||fs.mkdir(extensionsPath),_exist(historyPath)||fs.writeFile(historyPath,'{"history":[]}')}func.onTrayClick=config.get('hide-via-tray')||config.get('minimize-to-tray')?func.toggleVisibility:func.toggleMinimize,func.onRaise=config.get('hide-via-tray')||config.get('minimize-to-tray')?func.showInvisibleWindow:func.showMinimizedWindow;var booter;config.get('allow-multiple-instances')||(booter=monogamous({sock:pkg.name}),booter.on('boot',startApp),booter.on('reboot',func.onRaise),booter.on('error',function(b){logger.info('Ignoring boot error '+b+' while connecting to monogamous server'),startApp()}));function truncateStr(a,b){return a.length>b?a.slice(0,b-2)+'\u2026':a}function startApp(){function a(){config.set('window-info',func.browserWindow.getBounds())}var b=config.get('window-info')||{},c={frame:!0,resizable:!0,transparent:!0,autoHideMenuBar:!1,titleBarStyle:'hidden-inset',height:b.height||920,width:b.width||1024,x:b.x||null,y:b.y||null,icon:appIcons['icon-32'],preload:__dirname+'/js/browser.js',title:'Fuzium'};if(func.browserWindow=new BrowserWindow(c),logger.info('\n\n App is ready:',{version:pkg.version,platform:process.platform,options:c,processVersions:process.versions}),config.get('minimize-to-tray')&&func.browserWindow.on('minimize',func.toggleVisibility),func.browserWindow.on('move',_.debounce(function(){a()},250)),func.browserWindow.on('resize',_.debounce(function(){a()},250)),func.browserWindow.on('closed',function(){logger.debug('Fuzium shutting down.'),func.browserWindow=null,fuzium&&fusium.kill('SIGINT')}),func.browserWindow.webContents.session.on('will-download',(d,e)=>{e.setSavePath('files/'+e.getFilename());var g,h=0;e.on('updated',(j,k)=>{'interrupted'===k?console.log('Download interrupted but can be resumed'):'progressing'==k&&(e.isPaused()?console.log('Download is paused'):(h=parseInt(`${e.getReceivedBytes()}`),g!=h&&(console.log(`Received bytes: ${e.getReceivedBytes()}`),g=parseInt(`${e.getReceivedBytes()}`))))}),e.once('done',(j,k)=>{'completed'===k?console.log('Completed. Check your app download folder'):console.log(`Download failed: ${k}`)})}),appMenu.init(func),appTray.init(func),func.browserWindow){setTimeout(function(){func.browserWindow.loadURL(HelloZeronet)},2e3),console.log('\n Electron is ready. Booting Zeronet..\n'),function(){if(1===process.argv.length){var f=app.getAppPath()+'\\bin\\zeronet.exe',g=ChildProcess.spawn(f,['--open_browser','']);g.stderr.on('data',function(m){console.error(m.toString())}),g.stdout.on('data',function(m){console.log(m.toString())})}for(var h=0;h<process.argv.length;h++)console.log('process #'+h+' = '+process.argv[h]);console.log('\nDetached: '+!0);var j=path.basename(process.execPath);console.log('App name = '+j);var k=path.resolve(process.execPath);console.log('Electron app = '+k);var f=path.resolve(path.join(__dirname,'/bin/zeronet.exe'));return console.log('Zeronet app = '+f+'\n'),spawnChild(f,['--open_browser',''])}()}}